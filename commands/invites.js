import * as Util from '#src/modules/util.js';

class Command {

	async onChatInput(msg, interaction){
    if (interaction.mention){
      const member = msg.guild.members.resolve(interaction.mention);

      const getGuildMemberInvites = async (member) => {
        const guild = member.guild;
        const invites = await guild.invites.fetch();
        
        if (!invites){
          return null;
        }

        return invites.filter(({inviter}) => inviter === member.user);
      }

      const invitesCount = member.user.data.invites || 0;

      const byInvitesCountContent = `–ó–∞ –≤—Ä–µ–º—è –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —É–ø–æ–º—è–Ω—É—Ç—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≥–ª–∞—Å–∏–ª ${ Util.ending(invitesCount, "—á–µ–ª–æ–≤–µ–∫", "", "", "–∞") }.`;

      const guildInvites = await getGuildMemberInvites(member);
      const byGuildDataContent = guildInvites && guildInvites.size ? `${ member.displayName } —Å–æ–∑–¥–∞–ª(-a) ${ Util.ending(guildInvites.size, "", "—Å—Å—ã–ª–ª–æ–∫-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π", "—Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ", "—Å—Å—ã–ª–∫–∏-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è") } ‚Äî –ø–æ—Å–µ—Ç–∏–ª–æ ${ Util.ending(guildInvites.reduce((acc, invite) => (invite.uses || 0) + acc, 0), "–ø–µ—Ä—Å–æ–Ω", "", "–∞", "—ã") } <:treeJoke:827441080492490752>` : "";

      const description = `${ byInvitesCountContent }\n${ byGuildDataContent }`;
      const footer = {iconURL: member.user.avatarURL(), text: member.username};

      msg.msg({footer, description});
      return;
    }

    let answer = await Util.awaitUserAccept({name: "invites_command", message: {title: "–ü—Ä–∏—Å–≤–æ–π—Ç–µ —Å—Å—ã–ª–∫–∞–º –∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ä–æ–ª—å", description: "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?\n–í—ã –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç–µ —Ä–æ–ª—å, –Ω–∞–∑–æ–≤—ë–º –µ—ë \"–§—É–Ω—Ç–∏–∫\" –∏ —Ä–µ—à–∞–µ—Ç–µ, –∫–∞–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å –µ—ë –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É. –ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ —É—Å–ª–æ–≤–∏–π:\n\n1) –í —Ä–µ–∂–∏–º–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏: –í—Å–µ–º –∑–∞—à–µ–¥—à–∏–º —á–µ—Ä–µ–∑ —ç—Ç—É —Å—Å—ã–ª–∫—É –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω–∞ —Ä–æ–ª—å –§—É–Ω—Ç–∏–∫.\n2) –í—ã–¥–∞–≤–∞–µ–º–∞—è —Ä–æ–ª—å –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –Ω–∞–ª–∏—á–∏–µ–º —É –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ –¥—Ä—É–≥–æ–π —Ä–æ–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, \"–•–æ—Ä–æ—à–∏–π –¥—Ä—É–≥\". –õ—é–±–∞—è —Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–∞—è –•–æ—Ä–æ—à–∏–º –¥—Ä—É–≥–æ–º –ø—Ä–µ–¥–≤–∫—É—à–∞–µ—Ç –§—É–Ω—Ç–∏–∫–∞ \n3) –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –µ—Å–ª–∏ –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –Ω–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã—à–µ.\n\n–ó–∞—á–µ–º —ç—Ç–æ?\n–í—ã –º–æ–∂–µ—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∫—Ç–æ –µ–≥–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª; –≤–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª—é–¥–µ–π –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—à–ª–∏ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∫–∏ –∏ –ø–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤—É, —Ç–æ–º—É –ø–æ–¥–æ–±–Ω–æ–µ. –≠—Ç–æ —Ç–æ, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã"}, channel: msg.channel, userData: interaction.userData});
    if (!answer) return;

    const numericReactions = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£"];

    const rulesList = msg.guild.data.inviteRules ||= [];
    const getListDescription = (list) => {
      if (list.length === 0){
        return "–û—Ç—Å—É—Å—Ç–≤—É—é—Ç";
      }

      const main = list
        .map(({type, roleId}) => `${ numericReactions.at(type) } <@&${ roleId }>`)
        .join("\n");

      return `üîß\n${ main }`;
    }

    let embed = {
      title: "–ü—Ä–∏—Å–≤–æ–π—Ç–µ —Å—Å—ã–ª–∫–∞–º –∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ä–æ–ª—å",
      description: `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å–ª–æ–≤–∏—è:\n\n1) –†–æ–ª—å –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å —Ç–µ, –∫—Ç–æ –ø–µ—Ä–µ—à—ë–ª –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Å—ã–ª–∫–µ.\n2) –í—ã–¥–∞–≤–∞—Ç—å —Ä–æ–ª—å —Ç–µ–º, –∫–æ–≥–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª —É—á–∞—Å—Ç–Ω–∏–∫ —Å–µ—Ä–≤–µ—Ä–∞ –∏–º–µ—é—â–∏–π –¥–∞–ª–µ–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Ä–æ–ª—å (–ü—Ä–∏–≥–ª–∞—Å–∏–ª ‚Äî —É—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–∑–¥–∞–ª —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä) \n3) –ë—É–¥–µ—Ç –≤—ã–¥–∞–Ω–∞ –≤—Å–µ–º, –∫—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª –Ω–∏–∫–∞–∫–æ–π —Ä–æ–ª–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—É–Ω–∫—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)\n\n–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ${ getListDescription(rulesList) }`,
      footer: {
        text: "–û—Ä–∏—Ñ–ª–µ–π–º. –°—Ç–æ–ø-–∫–æ–Ω—Ç—Ä–æ–ª—å"
      }
    }
    let message = await msg.msg(embed);
    embed.edit = true;
    
    let reactions = [...numericReactions, rulesList.length ? "üîß" : null];
    let react = await message.awaitReact({ user: msg.author, type: "all" }, ...reactions);

    if (!react){
      message.delete();
      return;
    }

    // TODO: 
    if (reaction === "üîß"){

    }
      
    // TODO: 
    if (numberReactions.include(reaction)){
      const type = numberReactions.indexOf(reaction);
      embed.description = `**–¢–∏–ø:** ${ ["–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞", "–Ω–∞–ª–∏—á–∏–µ —Ä–æ–ª–∏ —É –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ", "–≤—ã–¥–∞—á–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"][type] };\n\n–û—Ç–ª–∏—á–Ω–æ, `;
    }
    
  }


	options = {
	  "name": "invites",
	  "id": 56,
	  "media": {
	    "description": "\n\n–ü—Ä–∏—Å–≤–æ–π—Ç–µ —Å—Å—ã–ª–∫–∞–º –∏—Ö —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ä–æ–ª—å. –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?\n–í—ã –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç–µ —Ä–æ–ª—å, –Ω–∞–∑–æ–≤—ë–º –µ—ë \\\"–§—É–Ω—Ç–∏–∫\\\" –∏ —Ä–µ—à–∞–µ—Ç–µ, –∫–∞–∫–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –ø–æ–ª—É—á–∞—Ç—å –µ—ë –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ —É—Å–ª–æ–≤–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —ç—Ç–æ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç, –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏ –∏—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ.\n\n1) –í —Ä–µ–∂–∏–º–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π —Å—Å—ã–ª–∫–∏, –≤—ã –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∑—ã–≤–µ—Ç–µ –µ—ë, –∏ –≤—Å–µ–º, –∫—Ç–æ –ø—Ä–∏—à—ë–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ —ç—Ç—É —Å—Å—ã–ª–∫—É –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω–∞ —Ä–æ–ª—å –§—É–Ω—Ç–∏–∫.\n2) –í—ã–¥–∞–≤–∞–µ–º–∞—è —Ä–æ–ª—å –±—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –Ω–∞–ª–∏—á–∏–µ–º —É –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ –¥—Ä—É–≥–æ–π —Ä–æ–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, \\\"–•–æ—Ä–æ—à–∏–π –¥—Ä—É–≥\\\". –õ—é–±–∞—è —Å—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–∞—è \\\"–•–æ—Ä–æ—à–∏–º –¥—Ä—É–≥–æ–º\\\" –±—É–¥–µ—Ç –¥–∞–≤–∞—Ç—å –§—É–Ω—Ç–∏–∫–∞\n3) –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ï—Å–ª–∏ –Ω–µ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –Ω–∏ –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã—à–µ, –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω–∞ –Ω–∞—à–∞ —Ä–æ–ª—å\n\n–ó–∞—á–µ–º —ç—Ç–æ?\n–í—ã –º–æ–∂–µ—Ç–µ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –∫—Ç–æ –µ–≥–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª; –≤–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª—é–¥–µ–π –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—à–ª–∏ —Å –ø–∞—Ä—Ç–Ω—ë—Ä–∫–∏ –∏ –ø–æ –∑–Ω–∞–∫–æ–º—Å—Ç–≤—É, —Ç–æ–º—É –ø–æ–¥–æ–±–Ω–æ–µ. –≠—Ç–æ —Ç–æ, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã\n\n:pencil2:\n```python\n!invites #–±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤\n```\n\n"
	  },
	  "allias": "–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è"
	};
};

export default Command;